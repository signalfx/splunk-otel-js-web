default:
    image: 'cimg/node:22.13.0-browsers'

include:
    - project: 'ci-cd/templates'
      ref: master
      file: '/prodsec/.oss-scan.yml'

cache:
    key:
        files:
            - package-lock.json
    paths:
        - './node_modules'
        - './packages/*/node_modules'

stages:
    - setup
    - build
    - test
    - release

npm_install:
    stage: setup
    script:
        - npm ci --include=dev

check_version:
    stage: build
    script:
        - npm run version:check

check_tag:
    stage: build
    only:
        - /^v.*/
    script:
        - npm run tag:check

lint:
    stage: build
    script:
        - npm run lint
        - npm run lint:markdown

build:
    stage: build
    only:
        - /^[^v].*/
    artifacts:
        paths:
            - packages/*/dist/
    script:
        - npm run compile

build_artifacts:
    stage: build
    only:
        - /^v[0-9]+\.[0-9]+\.[0-9]+(-beta\.[0-9]+)?$/
    artifacts:
        paths:
            - artifacts/
    script:
        - if [ ! -d "artifacts" ]; then mkdir artifacts; fi
        - npm run compile

        # Check if the tag is a beta version
        - if [[ "$CI_COMMIT_TAG" =~ -beta\.[0-9]+$ ]]; then
          npm pack --tag beta --pack-destination artifacts --workspace packages/session-recorder --workspace packages/web;
          else
          npm pack --pack-destination artifacts --workspace packages/session-recorder --workspace packages/web;
          fi

        # complete artifacts & checksums
        - cp packages/*/dist/artifacts/* artifacts/
        - shasum -a 256 artifacts/* > artifacts/checksums.txt

unit_test:
    stage: test
    script:
        - npm ci --include=dev
        - npm run test:unit:ci

oss-scan:
    stage: test
    extends: .oss-scan

release_npm:
    artifacts:
        paths:
            - artifacts/
    stage: release
    only:
        - /^v[0-9]+\.[0-9]+\.[0-9]+(-beta\.[0-9]+)?$/
    script:
        # Authenticate to NPM
        - echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc

        # Publish to NPM with conditional tag
        - for f in artifacts/*.tgz; do
          if [[ "$CI_COMMIT_TAG" =~ -beta\.[0-9]+$ ]]; then
          npm publish --tag beta ./$f;
          else
          npm publish ./$f;
          fi;
          done;

        # Clean up
        - rm -f ~/.npmrc

release_github:
    artifacts:
        paths:
            - artifacts/
    stage: release
    only:
        - /^v[0-9]+\.[0-9]+\.[0-9]+(-beta\.[0-9]+)?$/
    script:
        # Install GitHub CLI
        - sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-key 23F3D4EA75716059
        - echo "deb [arch=$(dpkg --print-architecture)] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        - sudo apt update
        - sudo apt install gh

        # Create GitHub release with conditional prerelease flag
        - if [[ "$CI_COMMIT_TAG" =~ -beta\.[0-9]+$ ]]; then
          gh release create v${CI_COMMIT_REF_NAME:1} ./artifacts/* --target $CI_COMMIT_SHA --repo $GITHUB_REPOSITORY --prerelease;
          else
          gh release create v${CI_COMMIT_REF_NAME:1} ./artifacts/* --target $CI_COMMIT_SHA --repo $GITHUB_REPOSITORY;
          fi

release_cdn:
    artifacts:
        paths:
            - artifacts/
    stage: release
    only:
        - /^v[0-9]+\.[0-9]+\.[0-9]+(-beta\.[0-9]+)?$/
    needs: ['release_github']
    id_tokens:
        CI_JOB_JWT:
            aud: $CICD_VAULT_ADDR
    script:
        # Authenticate and release to CDN
        - creds-helper init && eval $(creds-helper aws --eval aws:v1/o11y-infra/role/o11y_gdi_otel_js_web_releaser_role)
        - node scripts/release-cdn.mjs v${CI_COMMIT_REF_NAME:1}
